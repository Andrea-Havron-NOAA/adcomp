<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>13 Simulation | The comprehensive TMB documentation</title>
  <meta name="description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="13 Simulation | The comprehensive TMB documentation" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://kaskr.github.io/adcomp/" />
  <meta property="og:image" content="https://kaskr.github.io/adcomp/images/cover.png" />
  <meta property="og:description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="github-repo" content="kaskr/adcomp" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="13 Simulation | The comprehensive TMB documentation" />
  
  <meta name="twitter:description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="twitter:image" content="https://kaskr.github.io/adcomp/images/cover.png" />




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Sparsity.html"/>
<link rel="next" href="Validation.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="Introduction.html"><a href="Introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="Tutorial.html"><a href="Tutorial.html"><i class="fa fa-check"></i><b>2</b> Tutorial</a><ul>
<li class="chapter" data-level="2.1" data-path="Tutorial.html"><a href="Tutorial.html#obtaining-data-and-parameter-values-from-r"><i class="fa fa-check"></i><b>2.1</b> Obtaining data and parameter values from R</a><ul>
<li class="chapter" data-level="2.1.1" data-path="Tutorial.html"><a href="Tutorial.html#list-of-data-macros"><i class="fa fa-check"></i><b>2.1.1</b> List of data macros</a></li>
<li class="chapter" data-level="2.1.2" data-path="Tutorial.html"><a href="Tutorial.html#list-of-parameter-macros"><i class="fa fa-check"></i><b>2.1.2</b> List of parameter macros</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="Tutorial.html"><a href="Tutorial.html#an-extended-c-language"><i class="fa fa-check"></i><b>2.2</b> An extended C++ language</a></li>
<li class="chapter" data-level="2.3" data-path="Tutorial.html"><a href="Tutorial.html#statistical-modelling"><i class="fa fa-check"></i><b>2.3</b> Statistical modelling</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="Structure-TMB.html"><a href="Structure-TMB.html"><i class="fa fa-check"></i><b>3</b> The structure of TMB</a></li>
<li class="chapter" data-level="4" data-path="matrix-arrays.html"><a href="matrix-arrays.html"><i class="fa fa-check"></i><b>4</b> Matrices and arrays</a><ul>
<li class="chapter" data-level="4.1" data-path="matrix-arrays.html"><a href="matrix-arrays.html#relationship-to-r"><i class="fa fa-check"></i><b>4.1</b> Relationship to R</a></li>
<li class="chapter" data-level="4.2" data-path="matrix-arrays.html"><a href="matrix-arrays.html#relationship-to-eigen"><i class="fa fa-check"></i><b>4.2</b> Relationship to Eigen</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="R-style-distribution.html"><a href="R-style-distribution.html"><i class="fa fa-check"></i><b>5</b> R style probability distributions</a></li>
<li class="chapter" data-level="6" data-path="Densities.html"><a href="Densities.html"><i class="fa fa-check"></i><b>6</b> Multivariate distributions</a><ul>
<li class="chapter" data-level="6.1" data-path="Densities.html"><a href="Densities.html#multivariate-normal-distributions"><i class="fa fa-check"></i><b>6.1</b> Multivariate normal distributions</a></li>
<li class="chapter" data-level="6.2" data-path="Densities.html"><a href="Densities.html#autoregressive-processes"><i class="fa fa-check"></i><b>6.2</b> Autoregressive processes</a></li>
<li class="chapter" data-level="6.3" data-path="Densities.html"><a href="Densities.html#gaussian-markov-random-fields-gmrf"><i class="fa fa-check"></i><b>6.3</b> Gaussian Markov random fields (GMRF)</a></li>
<li class="chapter" data-level="6.4" data-path="Densities.html"><a href="Densities.html#separable-construction-of-covariance-precision-matrices"><i class="fa fa-check"></i><b>6.4</b> Separable construction of covariance (precision) matrices</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Examples.html"><a href="Examples.html"><i class="fa fa-check"></i><b>7</b> Example collection</a><ul>
<li class="chapter" data-level="7.1" data-path="Examples.html"><a href="Examples.html#example-overview"><i class="fa fa-check"></i><b>7.1</b> Example overview</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="Errors.html"><a href="Errors.html"><i class="fa fa-check"></i><b>8</b> Compilation and run time errors</a><ul>
<li class="chapter" data-level="8.1" data-path="Errors.html"><a href="Errors.html#compilation-errors"><i class="fa fa-check"></i><b>8.1</b> Compilation errors</a></li>
<li class="chapter" data-level="8.2" data-path="Errors.html"><a href="Errors.html#run-time-errors"><i class="fa fa-check"></i><b>8.2</b> Run time errors</a><ul>
<li class="chapter" data-level="8.2.1" data-path="Errors.html"><a href="Errors.html#out-of-bounds-error"><i class="fa fa-check"></i><b>8.2.1</b> Out-of-bounds error</a></li>
<li class="chapter" data-level="8.2.2" data-path="Errors.html"><a href="Errors.html#floating-point-exception"><i class="fa fa-check"></i><b>8.2.2</b> Floating point exception</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Toolbox.html"><a href="Toolbox.html"><i class="fa fa-check"></i><b>9</b> Toolbox</a><ul>
<li class="chapter" data-level="9.0.1" data-path="Toolbox.html"><a href="Toolbox.html#non-normal-latent-variables-random-effects"><i class="fa fa-check"></i><b>9.0.1</b> Non-normal latent variables (random effects)</a></li>
<li class="chapter" data-level="9.0.2" data-path="Toolbox.html"><a href="Toolbox.html#discrete-latent-variables"><i class="fa fa-check"></i><b>9.0.2</b> Discrete latent variables</a></li>
<li class="chapter" data-level="9.0.3" data-path="Toolbox.html"><a href="Toolbox.html#mixture-models"><i class="fa fa-check"></i><b>9.0.3</b> Mixture models</a></li>
<li class="chapter" data-level="9.0.4" data-path="Toolbox.html"><a href="Toolbox.html#time-series"><i class="fa fa-check"></i><b>9.0.4</b> Time series</a></li>
<li class="chapter" data-level="9.0.5" data-path="Toolbox.html"><a href="Toolbox.html#spatial-models"><i class="fa fa-check"></i><b>9.0.5</b> Spatial models</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="CppTutorial.html"><a href="CppTutorial.html"><i class="fa fa-check"></i><b>10</b> C++ tutorial</a><ul>
<li class="chapter" data-level="10.0.1" data-path="CppTutorial.html"><a href="CppTutorial.html#i-know-r-but-not-c"><i class="fa fa-check"></i><b>10.0.1</b> I know R but not C++</a></li>
<li class="chapter" data-level="10.0.2" data-path="CppTutorial.html"><a href="CppTutorial.html#i-know-c"><i class="fa fa-check"></i><b>10.0.2</b> I know C++</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ModelObject.html"><a href="ModelObject.html"><i class="fa fa-check"></i><b>11</b> Model object</a></li>
<li class="chapter" data-level="12" data-path="Sparsity.html"><a href="Sparsity.html"><i class="fa fa-check"></i><b>12</b> Sparsity</a><ul>
<li class="chapter" data-level="12.1" data-path="Sparsity.html"><a href="Sparsity.html#conditional-independence-graphs-and-dags"><i class="fa fa-check"></i><b>12.1</b> Conditional independence graphs and DAGs</a><ul>
<li class="chapter" data-level="12.1.1" data-path="Sparsity.html"><a href="Sparsity.html#conditional-independence"><i class="fa fa-check"></i><b>12.1.1</b> Conditional independence</a></li>
<li class="chapter" data-level="12.1.2" data-path="Sparsity.html"><a href="Sparsity.html#node-removal-properties"><i class="fa fa-check"></i><b>12.1.2</b> Node removal properties</a></li>
<li class="chapter" data-level="12.1.3" data-path="Sparsity.html"><a href="Sparsity.html#directed-acyclic-graph"><i class="fa fa-check"></i><b>12.1.3</b> Directed acyclic graph</a></li>
<li class="chapter" data-level="12.1.4" data-path="Sparsity.html"><a href="Sparsity.html#the-effect-of-adding-data"><i class="fa fa-check"></i><b>12.1.4</b> The effect of adding data</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="Sparsity.html"><a href="Sparsity.html#the-theta-logistic-example"><i class="fa fa-check"></i><b>12.2</b> The theta logistic example</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="Simulation.html"><a href="Simulation.html"><i class="fa fa-check"></i><b>13</b> Simulation</a><ul>
<li class="chapter" data-level="13.1" data-path="Simulation.html"><a href="Simulation.html#overview-of-simulation-methods-in-tmb"><i class="fa fa-check"></i><b>13.1</b> Overview of simulation methods in TMB</a><ul>
<li class="chapter" data-level="13.1.1" data-path="Simulation.html"><a href="Simulation.html#standard-generators"><i class="fa fa-check"></i><b>13.1.1</b> Standard generators</a></li>
<li class="chapter" data-level="13.1.2" data-path="Simulation.html"><a href="Simulation.html#generators-for-density-objects"><i class="fa fa-check"></i><b>13.1.2</b> Generators for density objects</a></li>
<li class="chapter" data-level="13.1.3" data-path="Simulation.html"><a href="Simulation.html#controlling-the-random-seed"><i class="fa fa-check"></i><b>13.1.3</b> Controlling the random seed</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="Simulation.html"><a href="Simulation.html#simulation-blocks"><i class="fa fa-check"></i><b>13.2</b> Simulation blocks</a><ul>
<li class="chapter" data-level="13.2.1" data-path="Simulation.html"><a href="Simulation.html#a-linear-regression-example"><i class="fa fa-check"></i><b>13.2.1</b> A linear regression example</a></li>
<li class="chapter" data-level="13.2.2" data-path="Simulation.html"><a href="Simulation.html#a-simulation-study"><i class="fa fa-check"></i><b>13.2.2</b> A simulation study</a></li>
<li class="chapter" data-level="13.2.3" data-path="Simulation.html"><a href="Simulation.html#advanced-examples"><i class="fa fa-check"></i><b>13.2.3</b> Advanced examples</a></li>
<li class="chapter" data-level="13.2.4" data-path="Simulation.html"><a href="Simulation.html#further-notes"><i class="fa fa-check"></i><b>13.2.4</b> Further notes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="Validation.html"><a href="Validation.html"><i class="fa fa-check"></i><b>14</b> Validation</a><ul>
<li class="chapter" data-level="14.1" data-path="Validation.html"><a href="Validation.html#residuals"><i class="fa fa-check"></i><b>14.1</b> Residuals</a><ul>
<li class="chapter" data-level="14.1.1" data-path="Validation.html"><a href="Validation.html#models-without-random-effects"><i class="fa fa-check"></i><b>14.1.1</b> Models without random effects</a></li>
<li class="chapter" data-level="14.1.2" data-path="Validation.html"><a href="Validation.html#models-with-random-effects"><i class="fa fa-check"></i><b>14.1.2</b> Models with random effects</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="Validation.html"><a href="Validation.html#checking-the-laplace-approximation"><i class="fa fa-check"></i><b>14.2</b> Checking the Laplace approximation</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html"><i class="fa fa-check"></i><b>15</b> Atomic functions</a><ul>
<li class="chapter" data-level="15.1" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#reverse-mode-differentiation"><i class="fa fa-check"></i><b>15.1</b> Reverse mode differentiation</a></li>
<li class="chapter" data-level="15.2" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#example-adding-new-primitive-function-with-known-derivatives"><i class="fa fa-check"></i><b>15.2</b> Example: Adding new primitive function with known derivatives</a><ul>
<li class="chapter" data-level="15.2.1" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#testing-the-primitive-function"><i class="fa fa-check"></i><b>15.2.1</b> Testing the primitive function</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#other-approaches"><i class="fa fa-check"></i><b>15.3</b> Other approaches</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="Appendix.html"><a href="Appendix.html"><i class="fa fa-check"></i><b>16</b> Appendix</a><ul>
<li class="chapter" data-level="16.1" data-path="Appendix.html"><a href="Appendix.html#notation"><i class="fa fa-check"></i><b>16.1</b> Notation</a></li>
<li class="chapter" data-level="16.2" data-path="Appendix.html"><a href="Appendix.html#profiling-the-inner-problem"><i class="fa fa-check"></i><b>16.2</b> Profiling the inner problem</a><ul>
<li class="chapter" data-level="16.2.1" data-path="Appendix.html"><a href="Appendix.html#example"><i class="fa fa-check"></i><b>16.2.1</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="16.3" data-path="Appendix.html"><a href="Appendix.html#theory-underlying-sdreport"><i class="fa fa-check"></i><b>16.3</b> Theory underlying sdreport</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The comprehensive TMB documentation</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Simulation" class="section level1">
<h1><span class="header-section-number">13</span> Simulation</h1>
<p>When building models in TMB it is generally recommended to test the
implementation on simulated data. Obviously, data can be simulated
from R and passed to the C++ template. In practice this amounts to
implementing the model twice and is thus a strong way to validate the
implementation of the model. However, with increased model complexity
it becomes inconvenient to maintain two separate
implementations. Therefore, TMB allows the the user to write the
simulation code as an integrated part of the C++ model template.</p>
<div id="overview-of-simulation-methods-in-tmb" class="section level2">
<h2><span class="header-section-number">13.1</span> Overview of simulation methods in TMB</h2>
<div id="standard-generators" class="section level3">
<h3><span class="header-section-number">13.1.1</span> Standard generators</h3>
<p>The TMB simulation routines use the same naming convention as the R
simulators. For instance <code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>()</code> is used to simulate from a normal
distribution. However, the argument convention is slightly
different:</p>
<ol style="list-style-type: decimal">
<li><code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(n, mu, sd)</code> draws <code>n</code> simulations from a normal
distribution. Unlike R this works for <strong>scalar parameters only</strong>.</li>
<li><code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(mu, sd)</code> is a TMB specific variant that works for
<strong>mixed scalar and vector input</strong>. Output length follows the length of the
longest input (no re-cycling) hence is consistent with <code>dnorm(mu, sd)</code>.</li>
</ol>
<p>Currently the following simulators are implemented:</p>
<blockquote>
<p><code><a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e">rpois</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a6bba21a2132e3504e183cdcd3e3e30cd">runif</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a29a4e821ec4b62567f8b40ab6ae78187">rbinom</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a74162523131288cf49a0d5d2e7c55253">rgamma</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#ae83ce74738a3b97e3432225a9036c99a">rexp</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#ae5f4590feabf617af4f525518b5802b8">rbeta</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#afc356ef7a9514c2629dd14de76e7e265">rf</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a266f56242a3cae0326439727b9f20b47">rlogis</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#af610012a7bedea646cc43a7dff276639">rt</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a2f3b0e14bca65b9153d89e797bdc37dd">rweibull</a>()</code>, <code><a class="code" href="../distributions__R_8hpp.html#a6b70740b28883180856ab723d264c12a">rcompois</a>()</code>, <code><a class="code" href="../lgamma_8hpp.html#a37ea00b66863cc66e267cfc5ced6c9ee">rnbinom</a>()</code>, <code><a class="code" href="../lgamma_8hpp.html#abbdff2745abaa2784b9350f1db929c3e">rnbinom2</a>()</code></p>
</blockquote>
</div>
<div id="generators-for-density-objects" class="section level3">
<h3><span class="header-section-number">13.1.2</span> Generators for density objects</h3>
<p>Objects from the density namespace have their own <code><a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>()</code>
method. Taking the multivariate normal distribution as example we have
the following ways to draw a simulation:</p>
<ol style="list-style-type: decimal">
<li><code><a class="code" href="../density_8hpp.html#a0ab00cdcb2757d23910a6d54523eec07">MVNORM</a>(Sigma).<a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>()</code> returns a vector with a simulation from
the multivariate normal distribution. The void argument version is
only available when there is no ambiguity in the dimension of the
output. In the <code>MVNORM</code> case the dimension of the output is known
from the dimension of <code>Sigma</code>. In other cases e.g. <code>AR1(phi)</code> the
dimension of the output is not known hence the void argument
version is not available.</li>
<li><code><a class="code" href="../density_8hpp.html#a0ab00cdcb2757d23910a6d54523eec07">MVNORM</a>(Sigma).<a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>(x)</code> pass <code>x</code> by reference and writes the
simulation directly to <code>x</code> without returning anything. This version
is available for <em>all</em> the classes because the dimension of the
simulation can always be deduced from <code>x</code>.</li>
</ol>
</div>
<div id="controlling-the-random-seed" class="section level3">
<h3><span class="header-section-number">13.1.3</span> Controlling the random seed</h3>
<p>All TMB simulation methods are based on R’s random number
generator. It follows that the random seed can be controlled from R
the usual way using <code>set.seed</code> even though the simulation is performed
on the C++ side.</p>
</div>
</div>
<div id="simulation-blocks" class="section level2">
<h2><span class="header-section-number">13.2</span> Simulation blocks</h2>
<p>Simulation functions can be called from anywhere in the C++
program. However, usually one should put the simulation code inside
specialized <em>simulation blocks</em> that allows the code to only be
executed when requested from R.</p>
<div id="a-linear-regression-example" class="section level3">
<h3><span class="header-section-number">13.2.1</span> A linear regression example</h3>
<p>A complete example extending the example <a href="../linreg_8cpp-example.html">linreg.cpp</a>
with simulation code is:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb33-1" data-line-number="1"></a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;<a class="code" href="../TMB_8hpp.html">TMB.hpp</a>&gt;</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb33-6" data-line-number="6">  <a class="code" href="../group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(y);</a>
<a class="sourceLine" id="cb33-7" data-line-number="7">  <a class="code" href="../group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(x);</a>
<a class="sourceLine" id="cb33-8" data-line-number="8">  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(a);</a>
<a class="sourceLine" id="cb33-9" data-line-number="9">  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(b);</a>
<a class="sourceLine" id="cb33-10" data-line-number="10">  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(sd);</a>
<a class="sourceLine" id="cb33-11" data-line-number="11">  <a class="code" href="../structvector.html">vector</a>&lt;Type&gt; mu = a + b * x;</a>
<a class="sourceLine" id="cb33-12" data-line-number="12">  Type nll = -<a class="code" href="../convenience_8hpp.html#a1fe3cb777e8fd8080385579ab87600e3">sum</a>(dnorm(y, mu, sd, <span class="kw">true</span>));</a>
<a class="sourceLine" id="cb33-13" data-line-number="13">  <a class="code" href="../group__macros.html#ga6c7c2eba6072ba55386fe72bc49604e2">SIMULATE</a> {</a>
<a class="sourceLine" id="cb33-14" data-line-number="14">    y = <a class="code" href="../distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(mu, sd);  <span class="co">// Simulate response</span></a>
<a class="sourceLine" id="cb33-15" data-line-number="15">    <a class="code" href="../group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(y);          <span class="co">// Report the simulation</span></a>
<a class="sourceLine" id="cb33-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb33-17" data-line-number="17">  <span class="cf">return</span> nll;</a>
<a class="sourceLine" id="cb33-18" data-line-number="18">}</a></code></pre></div>
<blockquote>
<p>The <code>SIMULATE</code> block marks the simulation and is not executed by default.</p>
</blockquote>
<p>We compile the C++-file and the model object is constructed as usual:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">obj &lt;-<span class="st"> </span><span class="kw">MakeADFun</span>(data, parameters, <span class="dt">DLL=</span><span class="st">&quot;linreg&quot;</span>)</a></code></pre></div>
<p>Now a simulation can be generated with</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">1</span>) ## optional</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">obj<span class="op">$</span><span class="kw">simulate</span>()</a></code></pre></div>
<pre><code>## $y
##  [1] -0.6264538  0.1836433 -0.8356286  1.5952808  0.3295078 -0.8204684
##  [7]  0.4874291  0.7383247  0.5757814 -0.3053884</code></pre>
<p>This only includes the simulated response - not the rest of the
data. A complete dataset can be generated by:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">1</span>) ## optional - Note: same y as previous</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">obj<span class="op">$</span><span class="kw">simulate</span>(<span class="dt">complete=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## $y
##  [1] -0.6264538  0.1836433 -0.8356286  1.5952808  0.3295078 -0.8204684
##  [7]  0.4874291  0.7383247  0.5757814 -0.3053884
## 
## $x
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## attr(,&quot;check.passed&quot;)
## [1] TRUE</code></pre>
<p>Here we did not explicitely state the parameter values to use with the
simulation. The <code>simulate</code> method takes an additional argument <code>par</code>
that can be used for this.</p>
<blockquote>
<p>The default parameter values used for the simulation is
<code>obj$env$last.par</code>.</p>
</blockquote>
</div>
<div id="a-simulation-study" class="section level3">
<h3><span class="header-section-number">13.2.2</span> A simulation study</h3>
<p>Simulating datasets from known parameters and re-estimationg those
parameters can be done generically by:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">sim &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">50</span>, {</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">  simdata &lt;-<span class="st"> </span>obj<span class="op">$</span><span class="kw">simulate</span>(<span class="dt">par=</span>obj<span class="op">$</span>par, <span class="dt">complete=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb39-3" data-line-number="3">  obj2 &lt;-<span class="st"> </span><span class="kw">MakeADFun</span>(simdata, parameters, <span class="dt">DLL=</span><span class="st">&quot;linreg&quot;</span>, <span class="dt">silent=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb39-4" data-line-number="4">  <span class="kw">nlminb</span>(obj2<span class="op">$</span>par, obj2<span class="op">$</span>fn, obj2<span class="op">$</span>gr)<span class="op">$</span>par</a>
<a class="sourceLine" id="cb39-5" data-line-number="5">})</a></code></pre></div>
<p>We reshape and plot the result:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="kw">library</span>(lattice)</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><a class="code" href="../group__R__style__distribution.html#ga6297091307163f5bb21e1a526fc8044a">df</a> &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">estimate=</span><span class="kw">as.vector</span>(sim), <span class="dt">parameter=</span><span class="kw">names</span>(obj<span class="op">$</span>par)[<span class="kw">row</span>(sim)])</a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="kw">densityplot</span>( <span class="op">~</span><span class="st"> </span>estimate <span class="op">|</span><span class="st"> </span>parameter, <span class="dt">data=</span><a class="code" href="../group__R__style__distribution.html#ga6297091307163f5bb21e1a526fc8044a">df</a>, <span class="dt">layout=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>))</a></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-29-1.svg" width="336" style="display: block; margin: auto;" /></p>
<p>Compare with the true parameter values of the simulation:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">obj<span class="op">$</span>par</a></code></pre></div>
<pre><code>##  a  b sd 
##  0  0  1</code></pre>
</div>
<div id="advanced-examples" class="section level3">
<h3><span class="header-section-number">13.2.3</span> Advanced examples</h3>
<p>The examples <a href="../sam_8cpp-example.html">sam.cpp</a> and <a href="../ar1_4D_8cpp-example.html">ar1_4D.cpp</a>
includes more advanced simulation code. The latter demonstrates how to
simulate from the density objects:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="co">// Separable covariance on 4D lattice with AR1 structure in each direction.</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;<a class="code" href="../TMB_8hpp.html">TMB.hpp</a>&gt;</span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3"></a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="co">/* Parameter transform */</span></a>
<a class="sourceLine" id="cb43-5" data-line-number="5"><span class="kw">template</span> &lt;<span class="kw">class</span> Type&gt;</a>
<a class="sourceLine" id="cb43-6" data-line-number="6">Type f(Type x){<span class="cf">return</span> Type(<span class="dv">2</span>)/(Type(<span class="dv">1</span>) + exp(-Type(<span class="dv">2</span>) * x)) - Type(<span class="dv">1</span>);}</a>
<a class="sourceLine" id="cb43-7" data-line-number="7"></a>
<a class="sourceLine" id="cb43-8" data-line-number="8"><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</a>
<a class="sourceLine" id="cb43-9" data-line-number="9">Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</a>
<a class="sourceLine" id="cb43-10" data-line-number="10">{</a>
<a class="sourceLine" id="cb43-11" data-line-number="11">  <a class="code" href="../group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(N)</a>
<a class="sourceLine" id="cb43-12" data-line-number="12">  <a class="code" href="../group__macros.html#ga6ac3eddb1dd503ceaf4c6ac91546b23e">PARAMETER_ARRAY</a>(eta);</a>
<a class="sourceLine" id="cb43-13" data-line-number="13">  <a class="code" href="../group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(transf_phi); <span class="co">/* fastest running dim */</span></a>
<a class="sourceLine" id="cb43-14" data-line-number="14">  Type phi=f(transf_phi);</a>
<a class="sourceLine" id="cb43-15" data-line-number="15">  <a class="code" href="../group__macros.html#ga43a13c435127491364e4a167478f4992">ADREPORT</a>(phi);</a>
<a class="sourceLine" id="cb43-16" data-line-number="16"></a>
<a class="sourceLine" id="cb43-17" data-line-number="17">  <span class="kw">using</span> <span class="kw">namespace</span> <a class="code" href="../namespacedensity.html">density</a>;</a>
<a class="sourceLine" id="cb43-18" data-line-number="18">  Type res=<span class="dv">0</span>;</a>
<a class="sourceLine" id="cb43-19" data-line-number="19"></a>
<a class="sourceLine" id="cb43-20" data-line-number="20">  res+=AR1(phi,AR1(phi,AR1(phi,AR1(phi))))(eta);</a>
<a class="sourceLine" id="cb43-21" data-line-number="21"></a>
<a class="sourceLine" id="cb43-22" data-line-number="22">  <span class="co">// logdpois = N log lam - lam</span></a>
<a class="sourceLine" id="cb43-23" data-line-number="23">  <span class="cf">for</span>(<span class="dt">int</span> i=<span class="dv">0</span>;i&lt;N.size();i++)res-=N[i]*eta[i]-exp(eta[i]);</a>
<a class="sourceLine" id="cb43-24" data-line-number="24"></a>
<a class="sourceLine" id="cb43-25" data-line-number="25">  <a class="code" href="../group__macros.html#ga6c7c2eba6072ba55386fe72bc49604e2">SIMULATE</a> {</a>
<a class="sourceLine" id="cb43-26" data-line-number="26">    AR1(phi,AR1(phi,AR1(phi,AR1(phi)))).<a class="code" href="../atomic_8hpp.html#ad0e80df47530e00880f7396e7fde2782">simulate</a>(eta);</a>
<a class="sourceLine" id="cb43-27" data-line-number="27">    <a class="code" href="../structvector.html">vector</a>&lt;Type&gt; lam = exp(eta);</a>
<a class="sourceLine" id="cb43-28" data-line-number="28">    N = <a class="code" href="../distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e">rpois</a>(lam);</a>
<a class="sourceLine" id="cb43-29" data-line-number="29">    <a class="code" href="../group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(eta);</a>
<a class="sourceLine" id="cb43-30" data-line-number="30">    <a class="code" href="../group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(N);</a>
<a class="sourceLine" id="cb43-31" data-line-number="31">  }</a>
<a class="sourceLine" id="cb43-32" data-line-number="32"></a>
<a class="sourceLine" id="cb43-33" data-line-number="33">  <span class="cf">return</span> res;</a>
<a class="sourceLine" id="cb43-34" data-line-number="34"></a>
<a class="sourceLine" id="cb43-35" data-line-number="35">}</a></code></pre></div>
<p>In this example the 4D-array <code>eta</code> is passed to the simulator by
reference. Thereby the simulator knows the dimension of <code>eta</code> and can
fill <code>eta</code> with a simulation.</p>
</div>
<div id="further-notes" class="section level3">
<h3><span class="header-section-number">13.2.4</span> Further notes</h3>
<p>The above example only used one simulation block. In general there is
no limitation on the number of simulation blocks that can be used in a
model and simulation blocks can use temporaries calculated outside the
blocks (as demonstrated in the linear regression example). For clarity
reasons, it is often a good idea to add a simulation block after each
likelihood contribution. However, note that simulation blocks are in
general <strong>not</strong> commutative (unlike likelihood accumulation). It is
therefore further recommended to add likelihood contributions of
random effects in the natural hierarchical order.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Sparsity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Validation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
